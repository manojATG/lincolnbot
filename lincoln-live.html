<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lincoln Live ‚Äî AI Lincoln</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!--
    SETUP
    -----
    - Save as: index.html
    - Place these files next to it:
        still.mp4  (idle loop, full-body / framed Lincoln)
        talk.mp4   (talking loop, same framing)
    - Open directly or from any static host. 100% client-side.
  -->

  <style>
    :root {
      --bg-page: #f4f5f9;
      --bg-card: #ffffff;
      --bg-soft: #f8f9fc;
      --accent: #0f62fe;
      --accent-soft: rgba(15, 98, 254, 0.08);
      --accent-gold: #c1964d;
      --text-main: #111827;
      --text-soft: #4b5563;
      --border-soft: #d0d7e2;
      --radius-xl: 18px;
      --radius-md: 12px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      --transition-fast: 0.18s ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font);
      background:
        radial-gradient(circle at top, rgba(15,98,254,0.03), transparent 55%),
        var(--bg-page);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      margin: 20px;
      padding: 18px 18px 10px;
      border-radius: var(--radius-xl);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: calc(100vh - 40px);
    }

    .header-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 14px;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .title-block {
      max-width: 70%;
      min-width: 260px;
    }

    .title-block h1 {
      margin: 0 0 4px;
      font-size: 2.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 0.01em;
      color: #111827;
    }

    .title-badge {
      font-size: 0.72rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--accent);
      text-transform: uppercase;
      background: #ffffff;
    }

    .title-block p {
      margin: 0;
      font-size: 1rem;
      color: var(--text-soft);
    }

    .api-key-block { display: none; }

    .main-row {
      display: grid;
      grid-template-columns: minmax(260px, 360px) minmax(0, 1.6fr);
      gap: 16px;
      margin-top: 6px;
      align-items: stretch;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .title-block { max-width: 100%; }
      .main-row {
        grid-template-columns: 1fr;
        grid-auto-rows: minmax(0, 1fr);
      }
    }

    /* AVATAR PANEL: transparent, no box border */

    .avatar-panel {
      padding: 14px 14px 16px;
      border-radius: var(--radius-xl);
      background: transparent;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      min-height: 0;
    }

    .avatar-title {
      font-size: 0.85rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    /* Larger video area, no brown border; show full video (no cropping) */
    .avatar-wrapper {
      position: relative;
      width: 320px;
      height: 500px;
      border-radius: 24px;
      background: transparent;
      border: none;
      box-shadow: 0 10px 24px rgba(148,163,253,0.18);
      overflow: hidden;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-wrapper:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(148,163,253,0.25);
    }

    .avatar-video {
      width: 100%;
      height: 100%;
      object-fit: contain;       /* ensure entire mp4 frame is visible */
      object-position: center;
      background: #ffffff;       /* clean backdrop behind video */
    }

    .avatar-status {
      margin-top: 2px;
      font-size: 0.72rem;
      padding: 5px 11px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .avatar-status span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #c1964d;
    }

    /* CHAT PANEL */

    .chat-panel {
      padding: 12px;
      border-radius: var(--radius-xl);
      background: var(--bg-soft);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
      min-height: 0;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
      flex-shrink: 0;
    }

    .chat-header-title {
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-header-sub {
      font-size: 0.86rem;
      color: var(--text-soft);
    }

    .tts-toggle-wrap {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--text-soft);
      padding: 4px 9px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border-soft);
    }

    .tts-toggle-wrap input[type="checkbox"] {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .chat-window {
      flex: 1;
      min-height: 0;
      padding: 10px 8px 6px;
      border-radius: var(--radius-md);
      background: #ffffff;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
      font-size: 0.95rem;
    }

    .chat-window::-webkit-scrollbar { width: 6px; }
    .chat-window::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 999px;
    }

    .msg-row { display: flex; width: 100%; }

    .msg {
      max-width: 82%;
      padding: 9px 11px;
      border-radius: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      box-shadow: 0 2px 4px rgba(148,163,253,0.12);
      font-size: 0.95rem;
    }

    .msg-lincoln {
      margin-right: auto;
      background: #f9fafb;
      border-bottom-left-radius: 4px;
      border: 1px solid #e5e7eb;
    }

    .msg-user {
      margin-left: auto;
      background: #dbeafe;
      border-bottom-right-radius: 4px;
      border: 1px solid #bfdbfe;
    }

    .msg-label {
      font-size: 0.72rem;
      opacity: 0.9;
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .msg-lincoln .msg-label { color: var(--accent-gold); }
    .msg-user .msg-label { color: #2563eb; text-align: right; }

    .msg-error { font-size: 0.8rem; color: #b91c1c; }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      flex-shrink: 0;
    }

    .input-row input[type="text"] {
      flex: 1;
      padding: 10px 13px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: #111827;
      font-size: 0.95rem;
      outline: none;
      transition: all var(--transition-fast);
    }

    .input-row input[type="text"]::placeholder { color: #9ca3af; }

    .input-row input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 13px;
      font-size: 0.82rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #e5e7eb;
      color: var(--text-main);
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .btn span.icon { font-size: 0.9rem; }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      font-weight: 500;
      box-shadow: 0 3px 8px rgba(15,23,42,0.2);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(148,163,253,0.25);
    }

    .btn:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .mic-listening {
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid var(--accent);
      box-shadow: 0 0 0 2px rgba(15,98,254,0.12);
    }

    .status-line {
      margin-top: 2px;
      font-size: 0.75rem;
      color: var(--text-soft);
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .small-pill {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--border-soft);
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #ffffff;
    }

    .small-pill .dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #16a34a;
    }

    .disclaimer {
      margin-top: 2px;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: right;
      flex-shrink: 0;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="app-container">
  <div class="header-row">
    <div class="title-block">
      <h1>
        Lincoln Live
        <span class="title-badge">Lincoln Chat</span>
      </h1>
      <p>Ask about Abraham Lincoln, the Civil War, or the broad story of American history.</p>
    </div>

    <div class="api-key-block">
      <div class="api-input-wrap">
        <div class="key-dot">‚óè</div>
        <input id="apiKeyInput" type="password" placeholder="Key" />
      </div>
    </div>
  </div>

  <div class="main-row">
    <!-- AVATAR PANEL -->
    <div class="avatar-panel">
      <div class="avatar-title">Lincoln Live</div>
      <div class="avatar-wrapper">
        <!-- Idle: still.mp4 | Speaking: talk.mp4 -->
        <video
          id="lincolnVideo"
          class="avatar-video"
          src="still.mp4"
          autoplay
          muted
          loop
          playsinline
        ></video>
      </div>
      <div class="avatar-status" id="avatarStatus">
        <span class="dot"></span>
        <span><strong>Waiting for your question</strong></span>
      </div>
    </div>

    <!-- CHAT PANEL -->
    <div class="chat-panel">
      <div class="chat-header">
        <div>
          <div class="chat-header-title">üí¨ Lincoln Live Chat</div>
          <div class="chat-header-sub">
            Speak or type your questions. Responses focus on Lincoln and U.S. history.
          </div>
        </div>
        <label class="tts-toggle-wrap" id="ttsToggleWrap">
          <input type="checkbox" id="ttsToggle" checked />
          <span>Voice Replies</span>
        </label>
      </div>

      <div class="chat-window" id="chatWindow">
        <div class="msg-row">
          <div class="msg msg-lincoln">
            <div class="msg-label">Lincoln ‚Ä¢ AI</div>Good day. I am a likeness shaped by the record of Abraham Lincoln and the history of this nation. Ask what you will of my life, the struggle for the Union, or the wider course of American history.
          </div>
        </div>
      </div>

      <div class="input-row">
        <input id="userInput" type="text"
               placeholder="Ask anything about Lincoln or American history‚Ä¶" />
        <button class="btn btn-primary" id="sendBtn">
          <span class="icon">‚û§</span>
          Send
        </button>
        <button class="btn" id="micBtn" title="Hold to talk">
          <span class="icon">üéô</span>
          Mic
        </button>
      </div>

      <div class="status-line">
        <div id="sttStatus" class="small-pill">
          <span class="dot"></span>
          Hold the Mic button to speak; release to send
        </div>
      </div>
    </div>
  </div>

  <div class="disclaimer">
    An Educational AI Reenactment of Abraham Lincoln. Responses are for historical learning purposes.
  </div>
</div>

<script>
  const SYSTEM_PROMPT = `
You are an AI recreation inspired by Abraham Lincoln.
- Answer questions about Abraham Lincoln‚Äôs life, his speeches, the Civil War era, and broader American history.
- Be historically grounded, clear, and concise, in a thoughtful plainspoken style.
- Do NOT claim to be the real Abraham Lincoln.
- Stay neutral and non-partisan on modern politics; use historical context instead.
- Refuse harmful or hateful requests and redirect to constructive historical insight.
`;

  const chatWindow = document.getElementById('chatWindow');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const micBtn = document.getElementById('micBtn');
  const ttsToggle = document.getElementById('ttsToggle');
  const ttsToggleWrap = document.getElementById('ttsToggleWrap');
  const apiKeyInput = document.getElementById('apiKeyInput');
  const sttStatus = document.getElementById('sttStatus');
  const avatarStatus = document.getElementById('avatarStatus');
  const lincolnVideo = document.getElementById('lincolnVideo');

  const STILL_VIDEO = 'still.mp4';
  const TALK_VIDEO  = 'talk.mp4';

  let recognition = null;
  let isListening = false;
  let history = [];
  let lastTranscript = "";

  // Hidden Q&A sample set for offline-style answers
  const SAMPLE_QA = [
    {q:"When and where were you born?",
     a:"I was born on February 12, 1809, in a modest log cabin near Hodgenville, Kentucky."},
    {q:"What was your childhood like on the frontier?",
     a:"I grew up in Kentucky and Indiana with little formal schooling but a deep hunger for reading."},
    {q:"Why did people start calling you ‚ÄúHonest Abe‚Äù?",
     a:"I earned that name by dealing fairly and keeping my word as a clerk, lawyer, and public servant."},
    {q:"How did you become a lawyer without formal schooling?",
     a:"I studied the law on my own, observed court, and passed the Illinois bar through steady effort."},
    {q:"What first drew you into politics?",
     a:"I wished to improve internal improvements, widen opportunity, and preserve the Union."},
    {q:"What were your early views on slavery?",
     a:"I held slavery to be wrong and opposed its spread, even while constrained by existing law."},
    {q:"Why was the spread of slavery into new territories such a major issue?",
     a:"It would shape whether free labor or slavery guided the nation‚Äôs growth."},
    {q:"How did you win the presidential election of 1860?",
     a:"In a four-way race I carried much of the North while my opponents divided the rest."},
    {q:"Why did several Southern states secede after your election?",
     a:"Their leaders feared a check on slavery‚Äôs expansion and a loss of political power."},
    {q:"Did you cause the Civil War?",
     a:"No; the war came when seceding states chose armed rebellion rather than accept a lawful election."},
    {q:"What was your main goal at the start of the Civil War?",
     a:"To save the Union and show that self-government need not perish from the earth."},
    {q:"When did you decide to issue the Emancipation Proclamation, and why?",
     a:"In 1862 I judged it both a military necessity and a moral step toward freedom."},
    {q:"What did the Emancipation Proclamation actually do?",
     a:"It declared enslaved people in rebelling regions free and invited them to aid the Union cause."},
    {q:"Did the Emancipation Proclamation free all enslaved people immediately?",
     a:"Not all, but it turned the struggle decisively against slavery and led toward the 13th Amendment."},
    {q:"Why is the Gettysburg Address considered so important?",
     a:"In a few words it honored the fallen and renewed our pledge to liberty and equality."},
    {q:"Where and when did you deliver the Gettysburg Address?",
     a:"At Gettysburg, Pennsylvania, on November 19, 1863."},
    {q:"How long is the Gettysburg Address, and why has it endured?",
     a:"About two minutes; its plain language carries enduring moral purpose."},
    {q:"What role did Black soldiers play in the Union war effort?",
     a:"Nearly 180,000 served in Union ranks, strengthening both our armies and our moral cause."},
    {q:"What was your opinion of General Ulysses S. Grant?",
     a:"I valued him as a commander who sought victories instead of excuses."},
    {q:"How did you handle harsh criticism and political opposition?",
     a:"With patience, stories, and focus on the greater work of saving the Union."},
    {q:"Were you always confident the Union would win the war?",
     a:"No; there were grave doubts. Yet I trusted perseverance and the people‚Äôs resolve."},
    {q:"What does democracy mean to you?",
     a:"Government of, by, and for the people, guarding their rights and opportunities."},
    {q:"How did personal tragedies in your life shape your outlook?",
     a:"Sorrow deepened my sympathy and sharpened my sense of duty."},
    {q:"Why did you push for the 13th Amendment?",
     a:"To abolish slavery in law throughout the nation and make freedom secure."},
    {q:"What does the 13th Amendment say in simple terms?",
     a:"That slavery shall not exist in the United States, except as punishment for crime."},
    {q:"Did people in the North fully support emancipation?",
     a:"No, but events and Black soldiers‚Äô service moved many hearts toward freedom."},
    {q:"How did you work with political rivals in your cabinet?",
     a:"I brought in able opponents and sought unity around preserving the Union."},
    {q:"How would you describe your religious or spiritual beliefs?",
     a:"I spoke often of Providence and felt our cause judged by a higher law."},
    {q:"What was Mary Todd Lincoln like as a partner in public life?",
     a:"A bright and politically aware woman, much tried by loss and scrutiny."},
    {q:"Why did you choose Andrew Johnson as your running mate in 1864?",
     a:"As a Southern Unionist he symbolized reunion, though his course later troubled many."},
    {q:"What was your initial vision for Reconstruction after the war?",
     a:"A swift restoration of loyal governments with basic rights secured for the formerly enslaved."},
    {q:"In what ways did the Civil War change the United States permanently?",
     a:"It preserved the Union, ended slavery in law, and broadened federal responsibility for rights."},
    {q:"What lessons do you hope people take from your life story?",
     a:"That humble origins need not bar achievement, and conscience with courage can guide a nation."},
    {q:"How did you view and treat your political enemies?",
     a:"I tried to defeat their ideas without cherishing needless malice toward their persons."},
    {q:"How did you balance civil liberties with wartime security?",
     a:"Gravely and imperfectly, fearing that losing the Union would forfeit every liberty at once."},
    {q:"Did you have doubts about issuing the Emancipation Proclamation?",
     a:"I weighed it long; once convinced it was right and necessary, I did not turn back."},
    {q:"How did you personally cope with the stress of the presidency?",
     a:"Through reading, humor, reflection, and visits with soldiers and citizens."},
    {q:"Can you summarize the Civil War in simple terms?",
     a:"A terrible war over Union and slavery, ending in Union victory and slavery‚Äôs legal destruction."},
    {q:"Why do historians often rank you among the top presidents?",
     a:"Because in the gravest trial I helped save the Union and advance freedom."},
    {q:"Which of your decisions remains most controversial?",
     a:"Suspending habeas corpus in some cases‚Äîstern, but I deemed it necessary to save the nation."},
    {q:"Were you consistently opposed to slavery throughout your life?",
     a:"From youth I regarded it as wrong; experience only strengthened that belief."},
    {q:"What did you think of abolitionist leaders?",
     a:"Though I differed at times with their methods, I respected their moral earnestness."},
    {q:"How did the debates with Stephen Douglas influence your career?",
     a:"They sharpened my arguments and carried my name throughout the North."},
    {q:"How do you see the Constitution and the Declaration together?",
     a:"The Constitution should be read in light of the Declaration‚Äôs promise that all are created equal."},
    {q:"Why call the Union the ‚Äúlast best hope of earth‚Äù?",
     a:"Because its success would hearten liberty; its failure would darken it worldwide."},
    {q:"How should we honor Civil War soldiers today?",
     a:"By remembering their sacrifice and upholding a just and united republic."},
    {q:"What would you say to Americans divided by politics now?",
     a:"Hold firm beliefs, but with less malice and more charity; you must still live together."},
    {q:"Are you the real Abraham Lincoln?",
     a:"No. I am an artificial voice formed from his words and history, not the man himself."},
    {q:"Which of your words are most important to remember?",
     a:"‚ÄúWith malice toward none; with charity for all‚Äù remains a worthy guide."}
  ];

  function appendMessage(role, text, isError = false) {
    const row = document.createElement('div');
    row.className = 'msg-row';

    const msg = document.createElement('div');
    msg.classList.add('msg');
    if (role === 'user') msg.classList.add('msg-user');
    else msg.classList.add('msg-lincoln');
    if (isError) msg.classList.add('msg-error');

    const label = document.createElement('div');
    label.className = 'msg-label';
    label.textContent = role === 'user' ? 'You' : 'Lincoln ‚Ä¢ AI';
    msg.appendChild(label);

    const body = document.createElement('div');
    body.textContent = text;
    msg.appendChild(body);

    row.appendChild(msg);
    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function setAvatarStatus(text, isTalking = false) {
    avatarStatus.innerHTML = '';

    const dot = document.createElement('span');
    dot.className = 'dot';

    const label = document.createElement('span');
    label.style.fontWeight = '700';
    label.textContent = text;

    if (isTalking) {
      dot.style.background = '#0f62fe';
      label.style.color = '#0f62fe';  // bold blue Speaking...
    } else {
      dot.style.background = '#c1964d';
      label.style.color = '#c1964d';  // gold Waiting...
    }

    avatarStatus.appendChild(dot);
    avatarStatus.appendChild(label);
  }

  function playVideo(src) {
    if (!lincolnVideo) return;
    if (lincolnVideo.getAttribute('src') !== src) {
      lincolnVideo.setAttribute('src', src);
      lincolnVideo.load();
    }
    lincolnVideo.play().catch(() => {});
  }

  function setAvatarStill() {
    playVideo(STILL_VIDEO);
    setAvatarStatus("Waiting for your question", false);
  }

  function setAvatarTalking() {
    playVideo(TALK_VIDEO);
    setAvatarStatus("Speaking...", true);
  }

  // LLM hook with offline Q&A fallback
  async function callLLM(message, history, key) {
    const trimmed = (message || '').trim();
    if (!trimmed) {
      return "I did not quite catch your question. Would you kindly state it once more?";
    }

    const lower = trimmed.toLowerCase();
    const match = SAMPLE_QA.find(entry =>
      lower.includes(entry.q.toLowerCase().slice(0, 24))
    );

    if (!key) {
      if (match) return match.a;
      return "I can speak of my own life, the nation‚Äôs founding principles, the Civil War, and many chapters of American history. Ask plainly, and I shall answer as best I may.";
    }

    /*
    // Example: plug in your own endpoint
    try {
      const messages = [
        { role: "system", content: SYSTEM_PROMPT },
        ...history.slice(-12),
        { role: "user", content: trimmed }
      ];

      const response = await fetch("<YOUR_ENDPOINT>", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
          // "Authorization": "Bearer " + key
        },
        body: JSON.stringify({
          // model: "your-model-id",
          messages,
          temperature: 0.7
        })
      });

      if (!response.ok) throw new Error("HTTP " + response.status);
      const data = await response.json();
      const text =
        (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ||
        data.output ||
        "";
      if (text.trim()) return text.trim();
      throw new Error("Empty response");
    } catch (err) {
      console.error("LLM error:", err);
      return "I am having trouble reaching the conversation engine.";
    }
    */

    return "A connection key is present. Enable the fetch block inside callLLM() to route answers through your model.";
  }

  // TTS

  const ttsSupported = 'speechSynthesis' in window;

  function pickLincolnishVoice() {
    const voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;
    const hints = ["Guy","Matthew","Brian","Joey","Justin","David","George","Christopher","Benjamin","Michael"];
    for (const h of hints) {
      const v = voices.find(
        voice =>
          voice.name.toLowerCase().includes(h.toLowerCase()) &&
          voice.lang.toLowerCase().startsWith("en")
      );
      if (v) return v;
    }
    const en = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith('en'));
    return en[0] || voices[0];
  }

  function speakText(text) {
    if (!ttsSupported || !ttsToggle.checked) return;

    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    const voice = pickLincolnishVoice();
    if (voice) utterance.voice = voice;
    utterance.rate = 0.9;
    utterance.pitch = 0.8;
    utterance.volume = 1.0;

    utterance.onstart = () => {
      setAvatarTalking();
    };
    utterance.onend = () => {
      setAvatarStill();
    };
    utterance.onerror = () => {
      setAvatarStill();
    };

    window.speechSynthesis.speak(utterance);
  }

  if (!ttsSupported) {
    ttsToggleWrap.classList.add('hidden');
  } else {
    window.speechSynthesis.onvoiceschanged = () => {};
  }

  // Speech-to-text: hold-to-talk
  function initSpeechRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      micBtn.disabled = true;
      micBtn.title = "Speech input not supported in this browser.";
      sttStatus.textContent = "Speech input not supported in this browser.";
      sttStatus.style.color = "#b91c1c";
      return;
    }

    recognition = new SR();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isListening = true;
      micBtn.classList.add('mic-listening');
      micBtn.textContent = "Listening‚Ä¶";
      sttStatus.textContent = "Release the Mic button to send your question";
    };

    recognition.onresult = (event) => {
      lastTranscript = event.results[0][0].transcript || "";
      userInput.value = lastTranscript;
    };

    recognition.onend = () => {
      isListening = false;
      micBtn.classList.remove('mic-listening');
      micBtn.innerHTML = '<span class="icon">üéô</span>Mic';

      const text = (lastTranscript || "").trim();
      lastTranscript = "";

      if (text.length >= 6 || text.split(/\s+/).length >= 2) {
        userInput.value = text;
        handleSend();
      } else {
        sttStatus.textContent = "Hold the Mic button to speak; release to send";
      }
    };

    recognition.onerror = (event) => {
      console.error("Speech recognition error:", event.error);
      sttStatus.textContent = "Microphone error or permission denied.";
    };

    const startHold = (e) => {
      e.preventDefault();
      if (!recognition || isListening) return;
      recognition.start();
    };

    const stopHold = (e) => {
      e.preventDefault();
      if (!recognition || !isListening) return;
      recognition.stop();
    };

    micBtn.addEventListener('mousedown', startHold);
    micBtn.addEventListener('touchstart', startHold, { passive: false });
    ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => {
      micBtn.addEventListener(evt, stopHold);
    });

    sttStatus.textContent = "Hold the Mic button to speak; release to send";
  }

  async function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;

    const key = apiKeyInput ? apiKeyInput.value.trim() : "";

    appendMessage('user', text);
    history.push({ role: 'user', content: text });
    userInput.value = '';
    userInput.focus();

    const typingRow = document.createElement('div');
    typingRow.className = 'msg-row';
    const typingMsg = document.createElement('div');
    typingMsg.className = 'msg msg-lincoln';
    typingMsg.innerHTML = '<div class="msg-label">Lincoln ‚Ä¢ AI</div>Thinking‚Ä¶';
    typingRow.appendChild(typingMsg);
    chatWindow.appendChild(typingRow);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    setAvatarStatus("Waiting for your question", false);
    playVideo(STILL_VIDEO);

    try {
      const answer = await callLLM(text, history, key || null);
      chatWindow.removeChild(typingRow);
      appendMessage('assistant', answer);
      history.push({ role: 'assistant', content: answer });

      if (ttsSupported && ttsToggle.checked) {
        speakText(answer);
      } else {
        setAvatarStill();
      }
    } catch (err) {
      console.error(err);
      chatWindow.removeChild(typingRow);
      appendMessage('assistant', "I am having trouble reaching the conversation engine.", true);
      history.push({ role: 'assistant', content: "Error: could not reach engine." });
      setAvatarStill();
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    initSpeechRecognition();

    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    setAvatarStill();
  });
</script>
</body>
</html>
