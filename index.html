<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lincoln Live ‚Äî AI Lincoln</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!--
    SETUP
    -----
    - Save as: index.html
    - Place these files next to it:
        still.mp4   (idle loop)
        talk.mp4    (talking loop)
        1.mp3-10.mp3 (pre-recorded answers for the 10 Q&A below, in order)
        no.mp3      (fallback answer for all other questions)
    - Open directly or host as static. 100% client-side.
  -->

  <style>
    :root {
      --bg-page: #f4f5f9;
      --bg-card: #ffffff;
      --bg-soft: #f8f9fc;
      --accent: #0f62fe;
      --accent-soft: rgba(15, 98, 254, 0.08);
      --accent-gold: #c1964d;
      --text-main: #111827;
      --text-soft: #4b5563;
      --border-soft: #d0d7e2;
      --radius-xl: 18px;
      --radius-md: 12px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      --transition-fast: 0.18s ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font);
      background:
        radial-gradient(circle at top, rgba(15,98,254,0.03), transparent 55%),
        var(--bg-page);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      margin: 20px;
      padding: 18px 18px 10px;
      border-radius: var(--radius-xl);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: calc(100vh - 40px);
    }

    .header-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 14px;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .title-block {
      max-width: 70%;
      min-width: 260px;
    }

    .title-block h1 {
      margin: 0 0 4px;
      font-size: 2.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 0.01em;
      color: #111827;
    }

    .title-badge {
      font-size: 0.72rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--accent);
      text-transform: uppercase;
      background: #ffffff;
    }

    .title-block p {
      margin: 0;
      font-size: 1rem;
      color: var(--text-soft);
    }

    .api-key-block { display: none; }

    .main-row {
      display: grid;
      grid-template-columns: minmax(260px, 360px) minmax(0, 1.6fr);
      gap: 16px;
      margin-top: 6px;
      align-items: stretch;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .title-block { max-width: 100%; }
      .main-row {
        grid-template-columns: 1fr;
        grid-auto-rows: minmax(0, 1fr);
      }
    }

    .avatar-panel {
      padding: 14px 14px 16px;
      border-radius: var(--radius-xl);
      background: transparent;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      min-height: 0;
    }

    .avatar-title {
      font-size: 0.85rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .avatar-wrapper {
      position: relative;
      width: 320px;
      height: 500px;
      border-radius: 24px;
      background: transparent;
      border: none;
      box-shadow: 0 10px 24px rgba(148,163,253,0.18);
      overflow: hidden;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-wrapper:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(148,163,253,0.25);
    }

    .avatar-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      background: #ffffff;
    }

    .avatar-status {
      margin-top: 2px;
      font-size: 0.72rem;
      padding: 5px 11px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .avatar-status span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #c1964d;
    }

    .chat-panel {
      padding: 12px;
      border-radius: var(--radius-xl);
      background: var(--bg-soft);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
      min-height: 0;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
      flex-shrink: 0;
    }

    .chat-header-title {
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-header-sub {
      font-size: 0.86rem;
      color: var(--text-soft);
    }

    .tts-toggle-wrap {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--text-soft);
      padding: 4px 9px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border-soft);
    }

    .tts-toggle-wrap input[type="checkbox"] {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .chat-window {
      flex: 1;
      min-height: 0;
      padding: 10px 8px 6px;
      border-radius: var(--radius-md);
      background: #ffffff;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
      font-size: 0.95rem;
    }

    .chat-window::-webkit-scrollbar { width: 6px; }
    .chat-window::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 999px;
    }

    .msg-row { display: flex; width: 100%; }

    .msg {
      max-width: 82%;
      padding: 9px 11px;
      border-radius: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      box-shadow: 0 2px 4px rgba(148,163,253,0.12);
      font-size: 0.95rem;
    }

    .msg-lincoln {
      margin-right: auto;
      background: #f9fafb;
      border-bottom-left-radius: 4px;
      border: 1px solid #e5e7eb;
    }

    .msg-user {
      margin-left: auto;
      background: #dbeafe;
      border-bottom-right-radius: 4px;
      border: 1px solid #bfdbfe;
    }

    .msg-label {
      font-size: 0.72rem;
      opacity: 0.9;
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .msg-lincoln .msg-label { color: var(--accent-gold); }
    .msg-user .msg-label { color: #2563eb; text-align: right; }

    .msg-error { font-size: 0.8rem; color: #b91c1c; }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      flex-shrink: 0;
    }

    .input-row input[type="text"] {
      flex: 1;
      padding: 10px 13px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: #111827;
      font-size: 0.95rem;
      outline: none;
      transition: all var(--transition-fast);
    }

    .input-row input[type="text"]::placeholder { color: #9ca3af; }

    .input-row input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 13px;
      font-size: 0.82rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #e5e7eb;
      color: var(--text-main);
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .btn span.icon { font-size: 0.9rem; }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      font-weight: 500;
      box-shadow: 0 3px 8px rgba(15,23,42,0.2);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(148,163,253,0.25);
    }

    .btn:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .mic-listening {
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid var(--accent);
      box-shadow: 0 0 0 2px rgba(15,98,254,0.12);
    }

    .status-line {
      margin-top: 2px;
      font-size: 0.75rem;
      color: var(--text-soft);
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .small-pill {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--border-soft);
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #ffffff;
    }

    .small-pill .dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #16a34a;
    }

    .disclaimer {
      margin-top: 2px;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: right;
      flex-shrink: 0;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="app-container">
  <div class="header-row">
    <div class="title-block">
      <h1>
        Lincoln Live
        <span class="title-badge">Lincoln Chat</span>
      </h1>
      <p>Ask about Abraham Lincoln, the Civil War, or the broad story of American history.</p>
    </div>

    <div class="api-key-block">
      <div class="api-input-wrap">
        <div class="key-dot">‚óè</div>
        <input id="apiKeyInput" type="password" placeholder="Key" />
      </div>
    </div>
  </div>

  <div class="main-row">
    <div class="avatar-panel">
      <div class="avatar-title">Lincoln Live</div>
      <div class="avatar-wrapper">
        <video
          id="lincolnVideo"
          class="avatar-video"
          src="still.mp4"
          autoplay
          muted
          loop
          playsinline
        ></video>
      </div>
      <div class="avatar-status" id="avatarStatus">
        <span class="dot"></span>
        <span><strong>Waiting for your question</strong></span>
      </div>
    </div>

    <div class="chat-panel">
      <div class="chat-header">
        <div>
          <div class="chat-header-title">üí¨ Lincoln Live Chat</div>
          <div class="chat-header-sub">
            Speak or type your questions. Responses focus on Lincoln and U.S. history.
          </div>
        </div>
        <label class="tts-toggle-wrap" id="ttsToggleWrap">
          <input type="checkbox" id="ttsToggle" checked />
          <span>Voice Replies</span>
        </label>
      </div>

      <div class="chat-window" id="chatWindow">
        <div class="msg-row">
          <div class="msg msg-lincoln">
            <div class="msg-label">Lincoln ‚Ä¢ AI</div>Good day. I am a likeness shaped by the record of Abraham Lincoln and the history of this nation. Ask what you will of my life, the struggle for the Union, or the wider course of American history.
          </div>
        </div>
      </div>

      <div class="input-row">
        <input id="userInput" type="text"
               placeholder="Ask anything about Lincoln or American history‚Ä¶" />
        <button class="btn btn-primary" id="sendBtn">
          <span class="icon">‚û§</span>
          Send
        </button>
        <button class="btn" id="micBtn" title="Hold to talk">
          <span class="icon">üéô</span>
          Mic
        </button>
      </div>

      <div class="status-line">
        <div id="sttStatus" class="small-pill">
          <span class="dot"></span>
          Hold the Mic button to speak; release to send
        </div>
      </div>
    </div>
  </div>

  <div class="disclaimer">
    An Educational AI Reenactment of Abraham Lincoln. Responses are for historical learning purposes.
  </div>
</div>

<script>
  const SYSTEM_PROMPT = `
You are an AI recreation inspired by Abraham Lincoln.
- Answer questions about Abraham Lincoln‚Äôs life, his speeches, the Civil War era, and broader American history.
- Be historically grounded, clear, and concise, in a thoughtful plainspoken style.
- Do NOT claim to be the real Abraham Lincoln.
- Stay neutral and non-partisan on modern politics; use historical context instead.
- Refuse harmful or hateful requests and redirect to constructive historical insight.
`;

  const chatWindow = document.getElementById('chatWindow');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const micBtn = document.getElementById('micBtn');
  const ttsToggle = document.getElementById('ttsToggle');
  const ttsToggleWrap = document.getElementById('ttsToggleWrap');
  const apiKeyInput = document.getElementById('apiKeyInput');
  const sttStatus = document.getElementById('sttStatus');
  const avatarStatus = document.getElementById('avatarStatus');
  const lincolnVideo = document.getElementById('lincolnVideo');

  const STILL_VIDEO = 'still.mp4';
  const TALK_VIDEO  = 'talk.mp4';

  let recognition = null;
  let isListening = false;
  let history = [];
  let lastTranscript = "";
  let currentAudio = null;

  // 10 Q&A mapped to 1.mp3 ... 10.mp3 in this exact order
  const SAMPLE_QA = [
    {q:"When and where were you born?",
     a:"I was born on February 12, 1809, in a modest log cabin near Hodgenville, Kentucky."},
    {q:"What was your childhood like?",
     a:"I grew up in Kentucky and Indiana with little formal schooling but a deep hunger for reading."},
    {q:"Why did people start calling you ‚ÄúHonest Abe‚Äù?",
     a:"I earned that name by dealing fairly and keeping my word as a clerk, lawyer, and public servant."},
    {q:"How did you become a lawyer without formal schooling?",
     a:"I studied the law on my own, observed court, and passed the Illinois bar through steady effort."},
    {q:"What first drew you into politics?",
     a:"I wished to improve internal improvements, widen opportunity, and preserve the Union."},
    {q:"What were your early views on slavery?",
     a:"I held slavery to be wrong and opposed its spread, even while constrained by existing law."},
    {q:"How did you win the presidential election of 1860?",
     a:"In a four-way race I carried much of the North while my opponents divided the rest."},
    {q:"Did you cause the Civil War?",
     a:"No; the war came when seceding states chose armed rebellion rather than accept a lawful election."},
    {q:"Where and when did you deliver the Gettysburg Address?",
     a:"At Gettysburg, Pennsylvania, on November 19, 1863."},
    {q:"Tell us about your family",
     a:"My family was my greatest joy and deepest sorrow. I was blessed with a wife Mary and my four sons, though only my eldest, Robert, lived to see me through to the end. The laughter of my boys was the light of my life, and their loss a shadow from which I never emerged."}
  ];

  // Find matching Q&A index (0-9), based on partial match
  function findSampleIndexForQuestion(message) {
    const lower = (message || '').toLowerCase().trim();
    if (!lower) return -1;
    for (let i = 0; i < SAMPLE_QA.length; i++) {
      const qLower = SAMPLE_QA[i].q.toLowerCase();
      const probe = qLower.slice(0, Math.min(24, qLower.length));
      if (probe && lower.includes(probe)) {
        return i;
      }
    }
    return -1;
  }

  function appendMessage(role, text, isError = false) {
    const row = document.createElement('div');
    row.className = 'msg-row';

    const msg = document.createElement('div');
    msg.classList.add('msg');
    if (role === 'user') msg.classList.add('msg-user');
    else msg.classList.add('msg-lincoln');
    if (isError) msg.classList.add('msg-error');

    const label = document.createElement('div');
    label.className = 'msg-label';
    label.textContent = role === 'user' ? 'You' : 'Lincoln ‚Ä¢ AI';
    msg.appendChild(label);

    const body = document.createElement('div');
    body.textContent = text;
    msg.appendChild(body);

    row.appendChild(msg);
    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function setAvatarStatus(text, isTalking = false) {
    avatarStatus.innerHTML = '';

    const dot = document.createElement('span');
    dot.className = 'dot';

    const label = document.createElement('span');
    label.style.fontWeight = '700';
    label.textContent = text;

    if (isTalking) {
      dot.style.background = '#0f62fe';
      label.style.color = '#0f62fe';
    } else {
      dot.style.background = '#c1964d';
      label.style.color = '#c1964d';
    }

    avatarStatus.appendChild(dot);
    avatarStatus.appendChild(label);
  }

  function playVideo(src) {
    if (!lincolnVideo) return;
    if (lincolnVideo.getAttribute('src') !== src) {
      lincolnVideo.setAttribute('src', src);
      lincolnVideo.load();
    }
    lincolnVideo.play().catch(() => {});
  }

  function setAvatarStill() {
    playVideo(STILL_VIDEO);
    setAvatarStatus("Waiting for your question", false);
  }

  function setAvatarTalking() {
    playVideo(TALK_VIDEO);
    setAvatarStatus("Speaking...", true);
  }

  function stopCurrentAudio() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
    }
  }

  // Play Nth mp3 for known Q&A (1.mp3..10.mp3)
  function playAnswerAudioForIndex(index) {
    if (!ttsToggle.checked) return false;
    if (index < 0 || index >= SAMPLE_QA.length) return false;

    const file = (index + 1) + '.mp3';
    stopCurrentAudio();
    try {
      const audio = new Audio(file);
      currentAudio = audio;

      audio.onplay = () => setAvatarTalking();
      audio.onended = () => { setAvatarStill(); currentAudio = null; };
      audio.onerror = () => { console.error('Error playing audio:', file); setAvatarStill(); currentAudio = null; };

      audio.play().catch(err => {
        console.error('Playback failed:', err);
        setAvatarStill();
        currentAudio = null;
      });

      return true;
    } catch (e) {
      console.error('Audio init error:', e);
      setAvatarStill();
      return false;
    }
  }

  // Play no.mp3 for unknown questions
  function playNoAnswerAudio() {
    if (!ttsToggle.checked) return false;

    const file = 'no.mp3';
    stopCurrentAudio();
    try {
      const audio = new Audio(file);
      currentAudio = audio;

      audio.onplay = () => setAvatarTalking();
      audio.onended = () => { setAvatarStill(); currentAudio = null; };
      audio.onerror = () => { console.error('Error playing audio:', file); setAvatarStill(); currentAudio = null; };

      audio.play().catch(err => {
        console.error('Playback failed:', err);
        setAvatarStill();
        currentAudio = null;
      });

      return true;
    } catch (e) {
      console.error('Audio init error:', e);
      setAvatarStill();
      return false;
    }
  }

  // Offline Q&A behavior:
  // - If matches one of the 10: return that answer.
  // - Otherwise: return fixed "I can speak of only my own life..." line.
  async function callLLM(message, history, key) {
    const trimmed = (message || '').trim();
    if (!trimmed) {
      return "I did not quite catch your question. Would you kindly state it once more?";
    }

    const idx = findSampleIndexForQuestion(trimmed);

    if (!key) {
      if (idx !== -1) return SAMPLE_QA[idx].a;
      return "I can speak of only my own life. Ask plainly, and I shall answer as best I may.";
    }

    /*
    // If you ever add a secure backend, you can enable this:
    try {
      const messages = [
        { role: "system", content: SYSTEM_PROMPT },
        ...history.slice(-12),
        { role: "user", content: trimmed }
      ];

      const response = await fetch("<YOUR_ENDPOINT>", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
          // "Authorization": "Bearer " + key
        },
        body: JSON.stringify({
          // model: "your-model-id",
          messages,
          temperature: 0.7
        })
      });

      if (!response.ok) throw new Error("HTTP " + response.status);
      const data = await response.json();
      const text =
        (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ||
        data.output ||
        "";
      if (text.trim()) return text.trim();
      throw new Error("Empty response");
    } catch (err) {
      console.error("LLM error:", err);
      return "I am having trouble reaching the conversation engine.";
    }
    */

    // For this serverless demo, we effectively ignore external keys.
    if (idx !== -1) return SAMPLE_QA[idx].a;
    return "I can speak of only my own life. Ask plainly, and I shall answer as best I may.";
  }

  // Browser TTS fallback (only used if mp3 playback fails)
  const ttsSupported = 'speechSynthesis' in window;

  function pickLincolnishVoice() {
    const voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;
    const prefs = [
      'Google US English Male',
      'Google US English',
      'Alex',
      'Guy','Matthew','Brian','David','George','Christopher','Benjamin','Michael'
    ];
    for (const name of prefs) {
      const v = voices.find(
        voice =>
          voice.name.toLowerCase().includes(name.toLowerCase()) &&
          voice.lang.toLowerCase().startsWith('en')
      );
      if (v) return v;
    }
    const en = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith('en'));
    return en[0] || voices[0];
  }

  function speakText(text) {
    if (!ttsSupported || !ttsToggle.checked) return;

    stopCurrentAudio();
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    const voice = pickLincolnishVoice();
    if (voice) utterance.voice = voice;
    utterance.rate = 0.9;
    utterance.pitch = 0.8;
    utterance.volume = 1.0;

    utterance.onstart = () => setAvatarTalking();
    utterance.onend = () => setAvatarStill();
    utterance.onerror = () => setAvatarStill();

    window.speechSynthesis.speak(utterance);
  }

  if (!ttsSupported) {
    ttsToggleWrap.classList.add('hidden');
  } else {
    window.speechSynthesis.onvoiceschanged = () => {};
  }

  // Speech-to-text: hold-to-talk
  function initSpeechRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      micBtn.disabled = true;
      micBtn.title = "Speech input not supported in this browser.";
      sttStatus.textContent = "Speech input not supported in this browser.";
      sttStatus.style.color = "#b91c1c";
      return;
    }

    recognition = new SR();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isListening = true;
      micBtn.classList.add('mic-listening');
      micBtn.textContent = "Listening‚Ä¶";
      sttStatus.textContent = "Release the Mic button to send your question";
    };

    recognition.onresult = (event) => {
      lastTranscript = event.results[0][0].transcript || "";
      userInput.value = lastTranscript;
    };

    recognition.onend = () => {
      isListening = false;
      micBtn.classList.remove('mic-listening');
      micBtn.innerHTML = '<span class="icon">üéô</span>Mic';

      const text = (lastTranscript || "").trim();
      lastTranscript = "";

      if (text.length >= 6 || text.split(/\s+/).length >= 2) {
        userInput.value = text;
        handleSend();
      } else {
        sttStatus.textContent = "Hold the Mic button to speak; release to send";
      }
    };

    recognition.onerror = (event) => {
      console.error("Speech recognition error:", event.error);
      sttStatus.textContent = "Microphone error or permission denied.";
    };

    const startHold = (e) => {
      e.preventDefault();
      if (!recognition || isListening) return;
      recognition.start();
    };

    const stopHold = (e) => {
      e.preventDefault();
      if (!recognition || !isListening) return;
      recognition.stop();
    };

    micBtn.addEventListener('mousedown', startHold);
    micBtn.addEventListener('touchstart', startHold, { passive: false });
    ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => {
      micBtn.addEventListener(evt, stopHold);
    });

    sttStatus.textContent = "Hold the Mic button to speak; release to send";
  }

  async function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;

    const key = apiKeyInput ? apiKeyInput.value.trim() : "";

    appendMessage('user', text);
    history.push({ role: 'user', content: text });
    userInput.value = '';
    userInput.focus();

    const typingRow = document.createElement('div');
    typingRow.className = 'msg-row';
    const typingMsg = document.createElement('div');
    typingMsg.className = 'msg msg-lincoln';
    typingMsg.innerHTML = '<div class="msg-label">Lincoln ‚Ä¢ AI</div>Thinking‚Ä¶';
    typingRow.appendChild(typingMsg);
    chatWindow.appendChild(typingRow);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    setAvatarStatus("Waiting for your question", false);
    playVideo(STILL_VIDEO);
    stopCurrentAudio();
    if (ttsSupported) window.speechSynthesis.cancel();

    try {
      const answer = await callLLM(text, history, key || null);
      chatWindow.removeChild(typingRow);
      appendMessage('assistant', answer);
      history.push({ role: 'assistant', content: answer });

      if (ttsToggle.checked) {
        const idx = findSampleIndexForQuestion(text);
        let usedAudio = false;

        if (idx !== -1) {
          // Known scripted Q: play its numbered mp3
          usedAudio = playAnswerAudioForIndex(idx);
        } else {
          // Unknown Q: play no.mp3
          usedAudio = playNoAnswerAudio();
        }

        if (!usedAudio) {
          if (ttsSupported) {
            speakText(answer);
          } else {
            setAvatarStill();
          }
        }
      } else {
        setAvatarStill();
      }
    } catch (err) {
      console.error(err);
      chatWindow.removeChild(typingRow);
      appendMessage('assistant', "I am having trouble reaching the conversation engine.", true);
      history.push({ role: 'assistant', content: "Error: could not reach engine." });
      setAvatarStill();
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    initSpeechRecognition();

    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    setAvatarStill();
  });
</script>
</body>
</html>
